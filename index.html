<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kay & Amy's Birthday</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#faf0e1;--ink:#45413c;--soft:#fff7fb;--line:#ffd7e6;--accent:#ff86b1;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Quicksand,system-ui,sans-serif;color:var(--ink);padding:20px}
.wrap{max-width:900px;margin:0 auto}
.hero{display:block;margin:0 auto 10px;width:min(320px,40vw);height:auto;border-radius:12px}
h1{margin:.2rem 0;color:var(--accent);text-align:center}
.card{background:var(--soft);border:2px solid var(--line);border-radius:18px;padding:18px;margin:16px 0;box-shadow:0 8px 18px rgba(0,0,0,.05)}
.card h2{margin:0 0 10px;color:var(--accent)}

.pills{display:flex;flex-wrap:wrap;gap:10px}
.pill{border:2px solid var(--line);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:700}
.pill[aria-pressed="true"]{background:linear-gradient(90deg,#ff86b1,#ffa8d0);color:#fff;border-color:#ff86b1}
.pill[disabled]{opacity:.4;cursor:not-allowed}

.input{width:100%;padding:12px 14px;border:2px solid var(--line);border-radius:12px;background:#fff}
.btn{margin-top:12px;padding:12px 20px;border:none;border-radius:14px;background:linear-gradient(90deg,#ff86b1,#ffa8d0);color:#fff;font-weight:700;cursor:pointer}
.note{font-size:13px;color:#6e6863}
.warn{color:#b35300}.ok{color:#2b8a3e}

/* Who‚Äôs coming grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.slotCard{border:2px solid var(--line);border-radius:16px;padding:12px;text-align:center;background:#fff}
.slotCard .time{font-weight:700;margin-bottom:6px}
.slotCard .count{font-size:13px;color:#777}
.names{margin-top:6px;font-size:13px;color:#555;min-height:18px}
.names strong{color:#333}
/* Bulleted list styling */
.names ul{margin:6px 0 0;padding-left:18px;text-align:left}
.names li{font-size:13px;color:#555;margin:2px 0}

/* Menu image */
.menu-img{display:block;width:100%;height:auto;border-radius:14px;border:2px solid var(--line);background:#fff}
.menu-caption{font-size:13px;color:#6e6863;margin-top:6px;text-align:center}
</style>
</head>
<body>
<main class="wrap">
  <img class="hero" src="./kay-amy-polaroid.png" alt="Kay & Amy">
  <h1>YOU ARE INVITED!!</h1>
  <h1>Come celebrate with Kay & Amy.</h1>

  <!-- Date & Time -->
  <section class="card">
    <h2>Date & Time</h2>
    <p><strong>Tuesday, September 2, 2025</strong></p>
    <p>Time slots from <strong>11:00 AM</strong> to <strong>9:00 PM</strong></p>
  </section>

  <!-- Who‚Äôs Coming (always visible, now before RSVP) -->
  <section id="who" class="card">
    <h2>Who‚Äôs Coming</h2>
    <div id="whoGrid" class="grid"></div>
    <p id="whoEmpty" class="note" style="margin-top:6px; display:none;">RSVPs will appear here.</p>
  </section>

  <!-- RSVP -->
  <section class="card">
    <h2>RSVP</h2>
    <form id="rsvpForm" novalidate>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Your Name</label>
          <input id="name" class="input" required>
        </div>
        <div>
          <label>Your Email</label>
          <input id="email" class="input" type="email" required>
        </div>
      </div>

      <p style="margin:12px 0 6px;">Will you attend?</p>
      <div class="pills" role="radiogroup" aria-label="RSVP">
        <button type="button" class="pill" id="yesBtn" aria-pressed="false">Yes üéâ</button>
        <button type="button" class="pill" id="noBtn"  aria-pressed="false">No üò¢</button>
      </div>

      <div id="slotPicker" style="display:none; margin-top:12px;">
        <p style="margin:0 0 8px;">Choose a time slot ‚è∞</p>
        <div id="slotPills" class="pills"></div>
        <p class="note">Limit 10 guests per slot. Full slots will be disabled.</p>
      </div>

      <button class="btn" type="submit">Submit RSVP</button>
      <p id="msg" class="note" role="status" aria-live="polite"></p>
    </form>
  </section>

    <!-- Menu (NEW, after RSVP) -->
  <section>
    <h2 style="color:var(--accent); text-align:center; margin:16px 0 10px;">Menu</h2>
    <img src="./menu.png" alt="Party menu with mains, sides, drinks, desserts, and other beverages" style="display:block; width:100%; height:auto; margin:0 auto; border-radius:12px;">
    <p style="font-size:13px; color:#6e6863; text-align:center; margin-top:6px;">
      Menu is subject to small changes on the day üåü
    </p>
  </section>


  <!-- Location -->
  <section class="card">
    <h2>üìç Location</h2>
    <p>16 Freeman St, Quincy, MA 02170</p>
    <iframe src="https://www.google.com/maps?q=16+Freeman+St,+Quincy,+MA+02170&output=embed" width="100%" height="300" style="border:0;border-radius:14px" loading="lazy" allowfullscreen></iframe>
  </section>
</main>

<script>
const API   = "https://script.google.com/macros/s/AKfycbyqe1OkhZnGhoTeJq4A73q3JNrczzAb5gE0tD7XSY1yEQ-4Z5NhF5aPsvTEeriNW1hxIA/exec";
const CAP   = 10;
const SLOTS = ["11:00 am","12:00 pm","1:00 pm","2:00 pm","3:00 pm","4:00 pm","5:00 pm","6:00 pm","7:00 pm","8:00 pm","9:00 pm"];

let summary = { ok:false, counts:{}, names:{} };
let attending = null;       // "yes" | "no"
let chosenSlot = null;      // string like "11:00 am"

// Elements
const yesBtn     = document.getElementById('yesBtn');
const noBtn      = document.getElementById('noBtn');
const slotPicker = document.getElementById('slotPicker');
const slotPills  = document.getElementById('slotPills');
const msg        = document.getElementById('msg');
const whoGrid    = document.getElementById('whoGrid');
const whoEmpty   = document.getElementById('whoEmpty');

// Toggle helpers
function setPressed(el, pressed){
  el.setAttribute('aria-pressed', pressed ? 'true' : 'false');
}
function clearSlotSelection(){
  chosenSlot = null;
  Array.from(slotPills.querySelectorAll('.pill')).forEach(p=>setPressed(p,false));
}

// RSVP buttons
yesBtn.addEventListener('click', () => {
  attending = 'yes';
  setPressed(yesBtn,true); setPressed(noBtn,false);
  slotPicker.style.display = 'block';
});
noBtn.addEventListener('click', () => {
  attending = 'no';
  setPressed(yesBtn,false); setPressed(noBtn,true);
  slotPicker.style.display = 'none';
  clearSlotSelection();
});

// Build slot buttons
function renderSlotPills(){
  slotPills.innerHTML = '';
  SLOTS.forEach(slot => {
    const count = Number(summary.counts?.[slot] || 0);
    const full  = count >= CAP;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'pill';
    btn.textContent = `${slot} ${count}/${CAP}`;
    if (full) btn.disabled = true;
    btn.addEventListener('click', () => {
      Array.from(slotPills.querySelectorAll('.pill')).forEach(p=>setPressed(p,false));
      setPressed(btn,true);
      chosenSlot = slot;
    });
    slotPills.appendChild(btn);
  });
}

// Always-visible ‚ÄúWho‚Äôs Coming‚Äù (bulleted names)
function renderNames(){
  whoGrid.innerHTML = '';
  let totalNames = 0;

  SLOTS.forEach(slot => {
    const people = summary.names?.[slot] || [];
    totalNames += people.length;
    if (!people.length) return;

    const card = document.createElement('div');
    card.className = 'slotCard';
    card.innerHTML = `
      <div class="time">${slot}</div>
      <div class="count">${people.length}/${CAP}</div>
      <div class="names">
        <ul>
          ${people.map(n=>`<li><strong>${escapeHtml(n)}</strong></li>`).join('')}
        </ul>
      </div>
    `;
    whoGrid.appendChild(card);
  });

  // Show placeholder text when there are no RSVPs yet
  whoEmpty.style.display = totalNames === 0 ? 'block' : 'none';
}

// Fetch current counts/names
async function loadSummary(){
  try{
    const res = await fetch(API + "?action=summary", {cache:"no-store"});
    const data = await res.json();
    summary = data && data.ok ? data : {ok:false,counts:{},names:{}};
  }catch(e){
    summary = {ok:false,counts:{},names:{}};
  }
  renderSlotPills();
  renderNames();
}

// Submit handler
document.getElementById('rsvpForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  msg.textContent = '';

  const name  = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();

  if (!name || !email){ msg.textContent = "Please enter your name and email."; return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ msg.textContent = "Please enter a valid email."; return; }
  if (!attending){ msg.textContent = "Please choose Yes or No."; return; }
  if (attending === 'yes' && !chosenSlot){ msg.textContent = "Please choose a time slot."; return; }

  try{
    const body = new URLSearchParams({
      name,
      email,
      status: attending,
      slot: attending === 'yes' ? (chosenSlot || '') : ''
    });

    const res = await fetch(API, {
      method: "POST",
      headers: {"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
      body
    });

    const data = await res.json();

    if (data.ok){
      msg.textContent = attending === 'yes'
        ? "Thanks! You're in. See you soon üéâ"
        : "Thanks for letting us know. We‚Äôll miss you!";
      msg.className = 'note ok';

      await loadSummary();

      attending = null;
      chosenSlot = null;
      setPressed(yesBtn,false); setPressed(noBtn,false);
      slotPicker.style.display = 'none';
      clearSlotSelection();
    }else{
      msg.textContent = data.error || "Something went wrong. Please try again.";
      msg.className = 'note warn';
      await loadSummary();
    }
  }catch(err){
    msg.textContent = "Network error ‚Äî please try again.";
    msg.className = 'note warn';
  }
});

// util: simple HTML escaper for names list
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

// initial fetch after everything is wired
loadSummary();
</script>
</body>
</html>
