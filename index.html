<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kay & Amy's Birthday</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#faf0e1;--ink:#45413c;--soft:#fff7fb;--line:#ffd7e6;--accent:#ff86b1;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:Quicksand,system-ui,sans-serif;color:var(--ink);padding:20px}
.wrap{max-width:900px;margin:0 auto}
.hero{display:block;margin:0 auto 10px;width:min(320px,40vw);height:auto;border-radius:12px}
h1{margin:.2rem 0;color:var(--accent);text-align:center}
.card{background:var(--soft);border:2px solid var(--line);border-radius:18px;padding:18px;margin:16px 0;box-shadow:0 8px 18px rgba(0,0,0,.05)}
.card h2{margin:0 0 10px;color:var(--accent)}

.pills{display:flex;flex-wrap:wrap;gap:10px}
.pill{border:2px solid var(--line);background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:700}
.pill[aria-pressed="true"]{background:linear-gradient(90deg,#ff86b1,#ffa8d0);color:#fff;border-color:#ff86b1}
.pill[disabled]{opacity:.4;cursor:not-allowed}

.input{width:100%;padding:12px 14px;border:2px solid var(--line);border-radius:12px;background:#fff}
.btn{margin-top:12px;padding:12px 20px;border:none;border-radius:14px;background:linear-gradient(90deg,#ff86b1,#ffa8d0);color:#fff;font-weight:700;cursor:pointer}
.note{font-size:13px;color:#6e6863}
.warn{color:#b35300}.ok{color:#2b8a3e}

/* ‚ÄúWho‚Äôs coming‚Äù cards */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.slotCard{border:2px solid var(--line);border-radius:16px;padding:12px;text-align:center;background:#fff}
.slotCard .time{font-weight:700;margin-bottom:6px}
.slotCard .count{font-size:13px;color:#777}
.names{margin-top:6px;font-size:13px;color:#555;min-height:18px}
.names strong{color:#333}
</style>
</head>
<body>
<main class="wrap">
  <img class="hero" src="./kay-amy-polaroid.png" alt="Kay & Amy">
  <h1>YOU ARE INVITED!!</h1>
  <h1>Come celebrate with Kay & Amy.</h1>

  <!-- Date & Time (no live grid here anymore) -->
  <section class="card">
    <h2>Date & Time</h2>
    <p><strong>Tuesday, September 2, 2025</strong></p>
    <p>Time slots from <strong>11:00 AM</strong> to <strong>9:00 PM</strong></p>
  </section>

  <!-- RSVP with pill time selection -->
  <section class="card">
    <h2>RSVP</h2>
    <form id="rsvpForm" novalidate>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Your Name</label>
          <input id="name" class="input" required>
        </div>
        <div>
          <label>Your Email</label>
          <input id="email" class="input" type="email" required>
        </div>
      </div>

      <p style="margin:12px 0 6px;">Will you attend?</p>
      <div class="pills" role="radiogroup" aria-label="RSVP">
        <button type="button" class="pill" id="yesBtn" aria-pressed="false">Yes üéâ</button>
        <button type="button" class="pill" id="noBtn"  aria-pressed="false">No üò¢</button>
      </div>

      <div id="slotPicker" style="display:none; margin-top:12px;">
        <p style="margin:0 0 8px;">Choose a time slot ‚è∞</p>
        <div id="slotPills" class="pills"></div>
        <p class="note">Limit 10 guests per slot. Full slots will be disabled.</p>
      </div>

      <button class="btn" type="submit">Submit RSVP</button>
      <p id="msg" class="note" role="status" aria-live="polite"></p>
    </form>
  </section>

  <!-- Live names BEFORE location -->
  <section class="card">
    <h2>Who‚Äôs coming (live)</h2>
    <div id="namesGrid" class="grid"></div>
  </section>

  <!-- Location -->
  <section class="card">
    <h2>üìç Location</h2>
    <p>16 Freeman St, Quincy, MA 02170</p>
    <iframe src="https://www.google.com/maps?q=16+Freeman+St,+Quincy,+MA+02170&output=embed" width="100%" height="300" style="border:0;border-radius:14px" loading="lazy" allowfullscreen></iframe>
  </section>
</main>

<script>
const API   = "https://script.google.com/macros/s/AKfycbwVyeyMx5mPBAcbsm2J4yHWH5KPw8m-eUHGsml2748Cgaz8bJexrg9b54-lKvDWVEXr/exec";
const CAP   = 10;
const SLOTS = ["11:00 am","12:00 pm","1:00 pm","2:00 pm","3:00 pm","4:00 pm","5:00 pm","6:00 pm","7:00 pm","8:00 pm","9:00 pm"];

let summary = {counts:{}, names:{}};

const yesBtn     = document.getElementById('yesBtn');
const noBtn      = document.getElementById('noBtn');
const slotPicker = document.getElementById('slotPicker');
const slotPills  = document.getElementById('slotPills');
const namesGrid  = document.getElementById('namesGrid');
const msg        = document.getElementById('msg');

let attending = "";   // "yes" | "no"
let chosenSlot = "";  // one of SLOTS

function setAttend(v){
  attending = v;
  yesBtn.setAttribute('aria-pressed', v==='yes');
  noBtn.setAttribute('aria-pressed',  v==='no');
  slotPicker.style.display = v==='yes' ? 'block' : 'none';
}
yesBtn.addEventListener('click', ()=> setAttend('yes'));
noBtn .addEventListener('click', ()=> setAttend('no'));

// build the selectable slot pills (with live capacity)
function renderSlotPills(){
  slotPills.innerHTML = "";
  SLOTS.forEach(s=>{
    const n = summary.counts[s]||0;
    const btn = document.createElement('button');
    btn.type='button';
    btn.className='pill';
    btn.textContent = `${s} ‚Äî ${n}/${CAP}`;
    btn.disabled = n>=CAP;
    btn.setAttribute('aria-pressed', chosenSlot===s);
    btn.addEventListener('click', ()=>{
      chosenSlot = s;
      [...slotPills.querySelectorAll('.pill')].forEach(b=>b.setAttribute('aria-pressed','false'));
      btn.setAttribute('aria-pressed','true');
    });
    slotPills.appendChild(btn);
  });
}

// live names per slot
function renderNames(){
  namesGrid.innerHTML = "";
  SLOTS.forEach(s=>{
    const div = document.createElement('div');
    div.className='slotCard';
    const list = (summary.names[s]||[]);
    div.innerHTML = `<div class="time">${s}</div>
                     <div class="count">${list.length}/${CAP}</div>
                     <div class="names">${list.length? `<strong>Guests:</strong> ${list.join(', ')}`:'-'}</div>`;
    namesGrid.appendChild(div);
  });
}

async function loadSummary(){
  try{
    const res = await fetch(API + "?action=summary", {cache:"no-store"});
    const data = await res.json();
    summary = data.ok ? data : {counts:{},names:{}};
  }catch{ summary = {counts:{},names:{}}; }
  renderSlotPills();
  renderNames();
}

document.getElementById('rsvpForm').addEventListener('submit', async (e)=>{
  e.preventDefault(); msg.textContent="";

  const name  = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();

  if (!name || !email){ msg.textContent="Please enter your name and email."; return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ msg.textContent="Please enter a valid email."; return; }
  if (!attending){ msg.textContent="Please choose Yes or No."; return; }
  if (attending==='yes' && !chosenSlot){ msg.textContent="Please choose a time slot."; return; }

  try{
    const body = new URLSearchParams({name,email,status:attending,slot:chosenSlot});
    const res  = await fetch(API, {method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}, body});

    if (res.status===409){
      msg.innerHTML="<span class='warn'>That slot just filled up. Please pick another.</span>";
      await loadSummary();
      return;
    }

    const data = await res.json().catch(()=>({}));
    if (data.ok){
      msg.innerHTML="<span class='ok'>RSVP saved ‚Äî thank you!</span>";
      e.target.reset(); setAttend(""); chosenSlot="";
      await loadSummary();
    } else {
      msg.innerHTML="<span class='warn'>Couldn‚Äôt save right now. Please try again.</span>";
    }
  }catch{
    msg.innerHTML="<span class='warn'>Network error. Check your /exec URL & access.</span>";
  }
});

// initial fetch
loadSummary();
</script>
</body>
</html>
